# ==========================================
# TRIGGER
# ==========================================
trigger:
  batch: true
  branches:
    include:
      - main
      - master
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml
    exclude:
      - README.md
      - '*.md'

pr: none

# ==========================================
# REPOSITORY
# ==========================================
resources:
  repositories:
    - repository: self
      type: github
      name: GAJENDRA-IGNT/Dynamic-CICD-Pipeline
      endpoint: GitHub-Connection

# ==========================================
# AGENT
# ==========================================
pool:
  vmImage: windows-latest

# ==========================================
# STAGES
# ==========================================
stages:

# ==========================================
# DEV STAGE
# ==========================================
- stage: DeployToDev
  displayName: Deploy to DEV
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: PublishToDev
    displayName: Publish Reports to DEV

    steps:
    - checkout: self
      persistCredentials: true

    # -------------------------------
    # Find PBIX Files
    # -------------------------------
    - task: PowerShell@2
      displayName: Find PBIX Files
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter "*.pbix" -File
          if ($pbixFiles.Count -eq 0) { throw "No PBIX files found" }
          $pbixFiles | Select -Expand FullName | ConvertTo-Json -Compress |
            %{ Write-Host "##vso[task.setvariable variable=ChangedPBIXFiles]$_" }

    # -------------------------------
    # Install Power BI Module
    # -------------------------------
    - task: PowerShell@2
      displayName: Install Power BI Module
      inputs:
        targetType: inline
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # -------------------------------
    # Publish Reports (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Publish Reports (DEV)
      inputs:
        targetType: inline
        script: |
          $pbixFiles = '$(ChangedPBIXFiles)' | ConvertFrom-Json

          foreach ($file in $pbixFiles) {
            & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -ReportPath $file `
              -FirstDeployment
          }

    # -------------------------------
    # TAKE DATASET OWNERSHIP (DEV)
    # ðŸ”‘ FIXES 403 PARAMETER ERRORS
    # -------------------------------
    - task: PowerShell@2
      displayName: Take Dataset Ownership (DEV)
      inputs:
        targetType: inline
        script: |
          if ($env:DatasetId) {
            & "$(Build.SourcesDirectory)/Scripts/Take-DatasetOwnership.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -DatasetId $env:DatasetId
          }

    # -------------------------------
    # Update OneDrive File Path (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Update OneDrive File Path (DEV)
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId $env:DatasetId `
            -OneDriveURL "$(OneDriveURL)" `
            -FilePath "$(DevFilePath)" `
            -Environment DEV

    # -------------------------------
    # Refresh Dataset (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Refresh Dataset (DEV)
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId $env:DatasetId

    # -------------------------------
    # Publish Artifacts
    # -------------------------------
    - task: PublishPipelineArtifact@1
      displayName: Publish Artifacts for PROD
      inputs:
        targetPath: $(Build.SourcesDirectory)
        artifact: PowerBIReports
        publishLocation: pipeline

# ==========================================
# PROD STAGE
# ==========================================
- stage: DeployToProd
  displayName: Deploy to PROD
  dependsOn: DeployToDev
  condition: succeeded()
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: PublishToProd
    displayName: Publish Reports to PROD
    environment: PowerBI-Production

    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: Download DEV Artifacts
            inputs:
              artifact: PowerBIReports
              path: $(Pipeline.Workspace)/PowerBIReports

          - task: PowerShell@2
            displayName: Install Power BI Module
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          # -------------------------------
          # Publish Reports (PROD)
          # -------------------------------
          - task: PowerShell@2
            displayName: Publish Reports (PROD)
            inputs:
              targetType: inline
              script: |
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/PowerBIReports/Reports" -Filter "*.pbix"

                foreach ($file in $pbixFiles) {
                  & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(ProdWorkspaceId)" `
                    -ReportPath $file.FullName `
                    -FirstDeployment
                }

          # -------------------------------
          # TAKE DATASET OWNERSHIP (PROD)
          # -------------------------------
          - task: PowerShell@2
            displayName: Take Dataset Ownership (PROD)
            inputs:
              targetType: inline
              script: |
                if ($env:DatasetId) {
                  & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Take-DatasetOwnership.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(ProdWorkspaceId)" `
                    -DatasetId $env:DatasetId
                }

          # -------------------------------
          # Update OneDrive File Path (PROD)
          # -------------------------------
          - task: PowerShell@2
            displayName: Update OneDrive File Path (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Update-OneDriveFilePath.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId $env:DatasetId `
                  -OneDriveURL "$(OneDriveURL)" `
                  -FilePath "$(ProdFilePath)" `
                  -Environment PROD

          # -------------------------------
          # Refresh Dataset (PROD)
          # -------------------------------
          - task: PowerShell@2
            displayName: Refresh Dataset (PROD)
            continueOnError: true
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Refresh-Dataset.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId $env:DatasetId
