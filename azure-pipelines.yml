# ==========================================
# GITHUB AUTO-TRIGGER CONFIGURATION
# ==========================================
trigger:
  batch: true
  branches:
    include:
      - main
      - master
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml
    exclude:
      - README.md
      - "*.md"
      - .gitignore

pr: none

# ==========================================
# GITHUB REPOSITORY CONNECTION
# ==========================================
resources:
  repositories:
    - repository: self
      type: github
      name: GAJENDRA-IGNT/Dynamic-CICD-Pipeline
      endpoint: GitHub-Connection

# ==========================================
# AGENT
# ==========================================
pool:
  vmImage: windows-latest

# ==========================================
# STAGES
# ==========================================
stages:

# ==========================================
# DEV STAGE
# ==========================================
- stage: DeployToDev
  displayName: Deploy to DEV (Automated)
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: PublishToDev
    displayName: Publish Reports to DEV

    steps:
    - checkout: self
      displayName: Checkout GitHub Repository
      persistCredentials: true

    # -------------------------------
    # Find PBIX Files
    # -------------------------------
    - task: PowerShell@2
      displayName: Find PBIX Files
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter "*.pbix" -File
          if ($pbixFiles.Count -eq 0) {
            Write-Error "No PBIX files found"
            exit 1
          }
          $json = $pbixFiles.FullName | ConvertTo-Json -Compress
          Write-Host "##vso[task.setvariable variable=ChangedPBIXFiles]$json"

    # -------------------------------
    # Install Power BI Module
    # -------------------------------
    - task: PowerShell@2
      displayName: Install Power BI Module
      inputs:
        targetType: inline
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # -------------------------------
    # Publish Reports (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Publish & Auto Take Over (DEV)
      inputs:
        targetType: inline
        script: |
          $pbixFiles = '$(ChangedPBIXFiles)' | ConvertFrom-Json

          Import-Module MicrosoftPowerBIMgmt
          $sec = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
          $cred = New-Object PSCredential("$(ServicePrincipalClientId)", $sec)

          Connect-PowerBIServiceAccount -ServicePrincipal `
            -Credential $cred `
            -TenantId "$(TenantId)"

          $existing = Get-PowerBIReport -WorkspaceId "$(DevWorkspaceId)" -ErrorAction SilentlyContinue

          foreach ($file in $pbixFiles) {
            $name = [IO.Path]::GetFileNameWithoutExtension($file)
            $exists = $existing | Where-Object Name -eq $name

            if ($exists) {
              & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                -ClientId "$(ServicePrincipalClientId)" `
                -ClientSecret "$(ServicePrincipalSecret)" `
                -TenantId "$(TenantId)" `
                -WorkspaceId "$(DevWorkspaceId)" `
                -ReportPath $file
            }
            else {
              & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                -ClientId "$(ServicePrincipalClientId)" `
                -ClientSecret "$(ServicePrincipalSecret)" `
                -TenantId "$(TenantId)" `
                -WorkspaceId "$(DevWorkspaceId)" `
                -ReportPath $file `
                -FirstDeployment
            }

            if ($LASTEXITCODE -ne 0) { exit 1 }
          }

    # -------------------------------
    # Update Parameters (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Update Parameters (DEV)
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          if (-not $env:DatasetId) { exit 0 }

          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId $env:DatasetId `
            -OneDriveSiteUrl "$(OneDriveURL)" `
            -OneDriveFilePath "$(DevFilePath)" `
            -Environment DEV

    # -------------------------------
    # Refresh Dataset (DEV)
    # -------------------------------
    - task: PowerShell@2
      displayName: Smart Refresh Dataset (DEV)
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          if (-not $env:DatasetId) { exit 0 }

          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId $env:DatasetId `
            -Environment DEV

    # -------------------------------
    # Publish Artifact
    # -------------------------------
    - task: PublishPipelineArtifact@1
      displayName: Publish Artifacts for PROD
      inputs:
        targetPath: $(Build.SourcesDirectory)
        artifact: PowerBIReports
        publishLocation: pipeline

# ==========================================
# PROD STAGE
# ==========================================
- stage: DeployToProd
  displayName: Deploy to PROD (Automated)
  dependsOn: DeployToDev
  condition: succeeded()
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: PublishToProd
    displayName: Publish Reports to PROD
    environment: PowerBI-Production

    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download Artifacts
            inputs:
              artifact: PowerBIReports
              path: $(Pipeline.Workspace)/PowerBIReports

          - task: PowerShell@2
            displayName: Install Power BI Module
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          - task: PowerShell@2
            displayName: Publish & Auto Take Over (PROD)
            inputs:
              targetType: inline
              script: |
                Import-Module MicrosoftPowerBIMgmt
                $sec = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
                $cred = New-Object PSCredential("$(ServicePrincipalClientId)", $sec)

                Connect-PowerBIServiceAccount -ServicePrincipal `
                  -Credential $cred `
                  -TenantId "$(TenantId)"

                $pbix = Get-ChildItem "$(Pipeline.Workspace)/PowerBIReports/Reports" -Filter "*.pbix"
                $existing = Get-PowerBIReport -WorkspaceId "$(ProdWorkspaceId)" -ErrorAction SilentlyContinue

                foreach ($f in $pbix) {
                  $name = [IO.Path]::GetFileNameWithoutExtension($f.Name)
                  $exists = $existing | Where-Object Name -eq $name

                  if ($exists) {
                    & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Publish-PowerBIReport.ps1" `
                      -ClientId "$(ServicePrincipalClientId)" `
                      -ClientSecret "$(ServicePrincipalSecret)" `
                      -TenantId "$(TenantId)" `
                      -WorkspaceId "$(ProdWorkspaceId)" `
                      -ReportPath $f.FullName
                  }
                  else {
                    & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Publish-PowerBIReport.ps1" `
                      -ClientId "$(ServicePrincipalClientId)" `
                      -ClientSecret "$(ServicePrincipalSecret)" `
                      -TenantId "$(TenantId)" `
                      -WorkspaceId "$(ProdWorkspaceId)" `
                      -ReportPath $f.FullName `
                      -FirstDeployment
                  }

                  if ($LASTEXITCODE -ne 0) { exit 1 }
                }
