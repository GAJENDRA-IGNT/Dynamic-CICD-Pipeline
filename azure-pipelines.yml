# ==========================================
# TRIGGER: Auto-run on GitHub commits
# ==========================================
trigger:
  batch: true
  branches:
    include:
      - main
      - master
  paths:
    include:
      - 'Reports/*.pbix'
      - 'Scripts/*.ps1'
      - 'azure-pipelines.yml'
    exclude:
      - 'README.md'
      - '*.md'

pr: none

# ==========================================
# RESOURCES: GitHub repository
# ==========================================
resources:
  repositories:
    - repository: self
      type: github
      name: GAJENDRA-IGNT/Dynamic-CICD-Pipeline
      endpoint: GitHub-Connection

# ==========================================
# AGENT
# ==========================================
pool:
  vmImage: 'windows-latest'

# ==========================================
# STAGES
# ==========================================
stages:

# ==========================================
# DEV STAGE
# ==========================================
- stage: DeployToDev
  displayName: 'Deploy to DEV'
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: PublishToDev
    displayName: 'Publish Reports to DEV'

    steps:
    - checkout: self
      persistCredentials: true

    # -------------------------------
    # Detect PBIX files
    # -------------------------------
    - task: PowerShell@2
      displayName: 'Find PBIX Files'
      inputs:
        targetType: 'inline'
        script: |
          $pbixFiles = Get-ChildItem -Path "$(Build.SourcesDirectory)/Reports" -Filter "*.pbix" -File

          if ($pbixFiles.Count -eq 0) {
              Write-Error "No PBIX files found!"
              exit 1
          }

          $filesJson = $pbixFiles | Select-Object -ExpandProperty FullName | ConvertTo-Json -Compress
          Write-Host "##vso[task.setvariable variable=ChangedPBIXFiles]$filesJson"

    # -------------------------------
    # Install Power BI Module
    # -------------------------------
    - task: PowerShell@2
      displayName: 'Install Power BI Module'
      inputs:
        targetType: 'inline'
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # -------------------------------
    # Publish to DEV
    # -------------------------------
    - task: PowerShell@2
      displayName: 'Publish & Auto Take Over (DEV)'
      inputs:
        targetType: 'inline'
        script: |
          $pbixFiles = '$(ChangedPBIXFiles)' | ConvertFrom-Json

          Import-Module MicrosoftPowerBIMgmt
          $securePassword = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("$(ServicePrincipalClientId)", $securePassword)

          Connect-PowerBIServiceAccount `
            -ServicePrincipal `
            -Credential $credential `
            -TenantId "$(TenantId)"

          $existingReports = Get-PowerBIReport -WorkspaceId "$(DevWorkspaceId)" -ErrorAction SilentlyContinue

          foreach ($filePath in $pbixFiles) {

              $reportName = [System.IO.Path]::GetFileNameWithoutExtension($filePath)
              $existingReport = $existingReports | Where-Object { $_.Name -eq $reportName }

              if ($existingReport) {
                  Write-Host "Updating report: $reportName"
                  & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(DevWorkspaceId)" `
                    -ReportPath $filePath
              }
              else {
                  Write-Host "First deployment: $reportName"
                  & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(DevWorkspaceId)" `
                    -ReportPath $filePath `
                    -FirstDeployment
              }

              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Publish failed for $reportName"
                  exit 1
              }
          }

    # -------------------------------
    # Refresh DEV Dataset
    # -------------------------------
    - task: PowerShell@2
      displayName: 'Refresh Dataset (DEV)'
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: |
          if ($env:DatasetId) {
            & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -DatasetId $env:DatasetId `
              -Environment "DEV"
          }

    # -------------------------------
    # Publish Artifacts
    # -------------------------------
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifacts for PROD'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'PowerBIReports'
        publishLocation: 'pipeline'

# ==========================================
# PROD STAGE
# ==========================================
- stage: DeployToProd
  displayName: 'Deploy to PROD'
  dependsOn: DeployToDev
  condition: succeeded()

  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: PublishToProd
    displayName: 'Publish Reports to PROD'
    environment: 'PowerBI-Production'

    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download DEV Artifacts'
            inputs:
              artifact: 'PowerBIReports'
              path: '$(Pipeline.Workspace)/PowerBIReports'

          - task: PowerShell@2
            displayName: 'Install Power BI Module'
            inputs:
              targetType: 'inline'
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          - task: PowerShell@2
            displayName: 'Publish & Auto Take Over (PROD)'
            inputs:
              targetType: 'inline'
              script: |
                Import-Module MicrosoftPowerBIMgmt
                $securePassword = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
                $credential = New-Object System.Management.Automation.PSCredential ("$(ServicePrincipalClientId)", $securePassword)

                Connect-PowerBIServiceAccount `
                  -ServicePrincipal `
                  -Credential $credential `
                  -TenantId "$(TenantId)"

                $existingReports = Get-PowerBIReport -WorkspaceId "$(ProdWorkspaceId)" -ErrorAction SilentlyContinue
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/PowerBIReports/Reports" -Filter "*.pbix" -File

                foreach ($file in $pbixFiles) {

                    $reportName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                    $existingReport = $existingReports | Where-Object { $_.Name -eq $reportName }

                    if ($existingReport) {
                        Write-Host "Updating PROD report: $reportName"
                        & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Publish-PowerBIReport.ps1" `
                          -ClientId "$(ServicePrincipalClientId)" `
                          -ClientSecret "$(ServicePrincipalSecret)" `
                          -TenantId "$(TenantId)" `
                          -WorkspaceId "$(ProdWorkspaceId)" `
                          -ReportPath $file.FullName
                    }
                    else {
                        Write-Host "First deployment to PROD: $reportName"
                        & "$(Pipeline.Workspace)/PowerBIReports/Scripts/Publish-PowerBIReport.ps1" `
                          -ClientId "$(ServicePrincipalClientId)" `
                          -ClientSecret "$(ServicePrincipalSecret)" `
                          -TenantId "$(TenantId)" `
                          -WorkspaceId "$(ProdWorkspaceId)" `
                          -ReportPath $file.FullName `
                          -FirstDeployment
                    }

                    if ($LASTEXITCODE -ne 0) {
                        Write-Error "PROD publish failed for $reportName"
                        exit 1
                    }
                }
