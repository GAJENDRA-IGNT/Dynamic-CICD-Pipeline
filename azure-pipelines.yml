# ==========================================
# TRIGGER
# ==========================================
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml

pr: none

# ==========================================
# AGENT
# ==========================================
pool:
  vmImage: windows-latest

# ==========================================
# STAGES
# ==========================================
stages:

# =====================================================
# DEV STAGE
# =====================================================
- stage: Deploy_DEV
  displayName: Deploy to DEV
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: DeployDEV
    displayName: Publish & Configure DEV

    steps:
    - checkout: self

    # ------------------------------------------
    # Install Power BI Module
    # ------------------------------------------
    - task: PowerShell@2
      displayName: Install Power BI Module
      inputs:
        targetType: inline
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # ------------------------------------------
    # Publish Report (DEV)
    # ------------------------------------------
    - task: PowerShell@2
      displayName: Publish Reports (DEV)
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter "*.pbix"

          foreach ($file in $pbixFiles) {
            & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -ReportPath $file.FullName `
              -FirstDeployment
          }

    # ------------------------------------------
    # Take Dataset Ownership (DEV)
    # ------------------------------------------
    - task: PowerShell@2
      displayName: Take Dataset Ownership (DEV)
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Take-DatasetOwnership.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # ------------------------------------------
    # Update Parameters (DEV) ✅ FIXED
    # ------------------------------------------
    - task: PowerShell@2
      displayName: Update Parameters (DEV)
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -OneDriveSiteUrl "$(OneDriveSiteUrl)" `
            -OneDriveFilePath "$(DevFilePath)" `
            -Environment "DEV"

    # ------------------------------------------
    # Refresh Dataset (DEV)
    # ------------------------------------------
    - task: PowerShell@2
      displayName: Refresh Dataset (DEV)
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # ------------------------------------------
    # Publish Artifact for PROD
    # ------------------------------------------
    - task: PublishPipelineArtifact@1
      displayName: Publish Artifact
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'PowerBIArtifact'


# =====================================================
# PROD STAGE
# =====================================================
- stage: Deploy_PROD
  displayName: Deploy to PROD
  dependsOn: Deploy_DEV
  condition: succeeded()
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: DeployPROD
    displayName: Publish & Configure PROD
    environment: PowerBI-PROD

    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: Download Artifact
            inputs:
              artifact: PowerBIArtifact
              path: $(Pipeline.Workspace)/PowerBIArtifact

          # ------------------------------------------
          # Install Power BI Module
          # ------------------------------------------
          - task: PowerShell@2
            displayName: Install Power BI Module
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          # ------------------------------------------
          # Publish Report (PROD)
          # ------------------------------------------
          - task: PowerShell@2
            displayName: Publish Reports (PROD)
            inputs:
              targetType: inline
              script: |
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/PowerBIArtifact/Reports" -Filter "*.pbix"

                foreach ($file in $pbixFiles) {
                  & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(ProdWorkspaceId)" `
                    -ReportPath $file.FullName `
                    -FirstDeployment
                }

          # ------------------------------------------
          # Take Dataset Ownership (PROD)
          # ------------------------------------------
          - task: PowerShell@2
            displayName: Take Dataset Ownership (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Take-DatasetOwnership.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"

          # ------------------------------------------
          # Update Parameters (PROD) ✅ FIXED
          # ------------------------------------------
          - task: PowerShell@2
            displayName: Update Parameters (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Update-OneDriveFilePath.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -OneDriveSiteUrl "$(OneDriveSiteUrl)" `
                  -OneDriveFilePath "$(ProdFilePath)" `
                  -Environment "PROD"

          # ------------------------------------------
          # Refresh Dataset (PROD)
          # ------------------------------------------
          - task: PowerShell@2
            displayName: Refresh Dataset (PROD)
            continueOnError: true
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Refresh-Dataset.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"
