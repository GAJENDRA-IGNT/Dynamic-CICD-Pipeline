# =========================================================
# POWER BI CI/CD PIPELINE (DEV â†’ PROD)
# Parameter-driven | Service Principal | Stable Refresh
# =========================================================

trigger:
  batch: true
  branches:
    include:
      - main
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml
    exclude:
      - README.md
      - '*.md'

pr: none

# =========================================================
# AGENT
# =========================================================
pool:
  vmImage: 'windows-latest'

# =========================================================
# STAGES
# =========================================================
stages:

# =========================================================
# DEV STAGE
# =========================================================
- stage: Deploy_DEV
  displayName: 'Deploy to DEV'
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: DEV_Deployment
    displayName: 'Publish & Configure DEV'
    steps:

    # -----------------------------------------------------
    # Checkout
    # -----------------------------------------------------
    - checkout: self
      persistCredentials: true

    # -----------------------------------------------------
    # Install Power BI Module
    # -----------------------------------------------------
    - task: PowerShell@2
      displayName: 'Install Power BI Module'
      inputs:
        targetType: inline
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # -----------------------------------------------------
    # Publish PBIX to DEV
    # -----------------------------------------------------
    - task: PowerShell@2
      displayName: 'Publish Reports (DEV)'
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter "*.pbix" -File
          if ($pbixFiles.Count -eq 0) { throw "No PBIX files found" }

          Import-Module MicrosoftPowerBIMgmt
          $securePassword = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
          $credential = New-Object PSCredential("$(ServicePrincipalClientId)", $securePassword)

          Connect-PowerBIServiceAccount `
            -ServicePrincipal `
            -Credential $credential `
            -TenantId "$(TenantId)"

          $existingReports = Get-PowerBIReport -WorkspaceId "$(DevWorkspaceId)" -ErrorAction SilentlyContinue

          foreach ($file in $pbixFiles) {
            $reportName = [IO.Path]::GetFileNameWithoutExtension($file.Name)
            $exists = $existingReports | Where-Object Name -eq $reportName

            if ($exists) {
              Write-Host "Updating DEV report: $reportName"
              & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                -ClientId "$(ServicePrincipalClientId)" `
                -ClientSecret "$(ServicePrincipalSecret)" `
                -TenantId "$(TenantId)" `
                -WorkspaceId "$(DevWorkspaceId)" `
                -ReportPath $file.FullName
            }
            else {
              Write-Host "First deployment DEV: $reportName"
              & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
                -ClientId "$(ServicePrincipalClientId)" `
                -ClientSecret "$(ServicePrincipalSecret)" `
                -TenantId "$(TenantId)" `
                -WorkspaceId "$(DevWorkspaceId)" `
                -ReportPath $file.FullName `
                -FirstDeployment
            }

            if ($LASTEXITCODE -ne 0) { throw "DEV publish failed" }
          }

    # -----------------------------------------------------
    # Take Dataset Ownership (DEV)
    # -----------------------------------------------------
    - task: PowerShell@2
      displayName: 'Take Dataset Ownership (DEV)'
      inputs:
        targetType: inline
        script: |
          if ($env:DatasetId) {
            & "$(Build.SourcesDirectory)/Scripts/Take-DatasetOwnership.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -DatasetId $env:DatasetId
          }

    # -----------------------------------------------------
    # Update Parameters (DEV)
    # -----------------------------------------------------
    - task: PowerShell@2
      displayName: 'Update Parameters (DEV)'
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -OneDriveURL "$(OneDriveSiteUrl)" `
            -FilePath "$(DevFilePath)"

    # -----------------------------------------------------
    # Refresh Dataset (DEV)
    # -----------------------------------------------------
    - task: PowerShell@2
      displayName: 'Refresh Dataset (DEV)'
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # -----------------------------------------------------
    # Publish Artifact for PROD
    # -----------------------------------------------------
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact'
      inputs:
        targetPath: '$(Build.SourcesDirectory)'
        artifact: 'PowerBIArtifact'
        publishLocation: pipeline

# =========================================================
# PROD STAGE
# =========================================================
- stage: Deploy_PROD
  displayName: 'Deploy to PROD'
  dependsOn: Deploy_DEV
  condition: succeeded()
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: PROD_Deployment
    displayName: 'Publish & Configure PROD'
    environment: 'PowerBI-Production'

    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Artifact'
            inputs:
              artifact: 'PowerBIArtifact'
              path: '$(Pipeline.Workspace)/PowerBIArtifact'

          - task: PowerShell@2
            displayName: 'Install Power BI Module'
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          - task: PowerShell@2
            displayName: 'Publish Reports (PROD)'
            inputs:
              targetType: inline
              script: |
                Import-Module MicrosoftPowerBIMgmt
                $securePassword = ConvertTo-SecureString "$(ServicePrincipalSecret)" -AsPlainText -Force
                $credential = New-Object PSCredential("$(ServicePrincipalClientId)", $securePassword)

                Connect-PowerBIServiceAccount `
                  -ServicePrincipal `
                  -Credential $credential `
                  -TenantId "$(TenantId)"

                $existingReports = Get-PowerBIReport -WorkspaceId "$(ProdWorkspaceId)" -ErrorAction SilentlyContinue
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/PowerBIArtifact/Reports" -Filter "*.pbix" -File

                foreach ($file in $pbixFiles) {
                  $reportName = [IO.Path]::GetFileNameWithoutExtension($file.Name)
                  $exists = $existingReports | Where-Object Name -eq $reportName

                  if ($exists) {
                    & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Publish-PowerBIReport.ps1" `
                      -ClientId "$(ServicePrincipalClientId)" `
                      -ClientSecret "$(ServicePrincipalSecret)" `
                      -TenantId "$(TenantId)" `
                      -WorkspaceId "$(ProdWorkspaceId)" `
                      -ReportPath $file.FullName
                  }
                  else {
                    & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Publish-PowerBIReport.ps1" `
                      -ClientId "$(ServicePrincipalClientId)" `
                      -ClientSecret "$(ServicePrincipalSecret)" `
                      -TenantId "$(TenantId)" `
                      -WorkspaceId "$(ProdWorkspaceId)" `
                      -ReportPath $file.FullName `
                      -FirstDeployment
                  }

                  if ($LASTEXITCODE -ne 0) { throw "PROD publish failed" }
                }

          - task: PowerShell@2
            displayName: 'Update Parameters (PROD)'
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Update-OneDriveFilePath.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -OneDriveURL "$(OneDriveSiteUrl)" `
                  -FilePath "$(ProdFilePath)"

          - task: PowerShell@2
            displayName: 'Refresh Dataset (PROD)'
            continueOnError: true
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/PowerBIArtifact/Scripts/Refresh-Dataset.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"
