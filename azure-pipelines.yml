# ==========================================
# TRIGGER CONFIGURATION
# ==========================================
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml

pr: none

pool:
  vmImage: windows-latest

# ==========================================
# DEV STAGE
# ==========================================
stages:
- stage: DeployToDev
  displayName: Deploy to DEV
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: DeployDEV
    displayName: Publish & Configure DEV
    steps:

    - checkout: self

    # -------------------------------
    # Install Power BI Module
    # -------------------------------
    - task: PowerShell@2
      displayName: Install Power BI Module
      inputs:
        targetType: inline
        script: |
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

    # -------------------------------
    # Publish PBIX
    # -------------------------------
    - task: PowerShell@2
      displayName: Publish PBIX to DEV
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter *.pbix

          foreach ($pbix in $pbixFiles) {
            & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -ReportPath $pbix.FullName
          }

    # =====================================================
    # TAKE DATASET OWNERSHIP  ðŸ”´ MISSING PIECE (NOW FIXED)
    # =====================================================
    - task: PowerShell@2
      displayName: Take Dataset Ownership (DEV)
      inputs:
        targetType: inline
        script: |
          if ([string]::IsNullOrEmpty("$(DatasetId)")) {
            Write-Error "DatasetId not found. Ownership cannot be taken."
            exit 1
          }

          & "$(Build.SourcesDirectory)/Scripts/Take-DatasetOwnership.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # -------------------------------
    # Update OneDrive Parameters
    # -------------------------------
    - task: PowerShell@2
      displayName: Update SharePoint Parameters (DEV)
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -SharePointSiteUrl "$(OneDriveSiteUrl)" `
            -FilePath  "$(DevFilePath)"

    # -------------------------------
    # Refresh Dataset
    # -------------------------------
    - task: PowerShell@2
      displayName: Refresh Dataset (DEV)
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # -------------------------------
    # Publish Artifacts for PROD
    # -------------------------------
    - task: PublishPipelineArtifact@1
      displayName: Publish Artifacts
      inputs:
        targetPath: $(Build.SourcesDirectory)
        artifact: PowerBIReports

# ==========================================
# PROD STAGE
# ==========================================
- stage: DeployToProd
  displayName: Deploy to PROD
  dependsOn: DeployToDev
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: DeployPROD
    displayName: Publish & Configure PROD
    environment: PowerBI-Production
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: PowerBIReports
              path: $(Pipeline.Workspace)

          - task: PowerShell@2
            displayName: Install Power BI Module
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          - task: PowerShell@2
            displayName: Publish PBIX to PROD
            inputs:
              targetType: inline
              script: |
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/Reports" -Filter *.pbix

                foreach ($pbix in $pbixFiles) {
                  & "$(Pipeline.Workspace)/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(ProdWorkspaceId)" `
                    -ReportPath $pbix.FullName
                }

          - task: PowerShell@2
            displayName: Take Dataset Ownership (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Take-DatasetOwnership.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"

          - task: PowerShell@2
            displayName: Update OneDrive Parameters (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Update-OneDriveFilePath.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -SharePointSiteUrl "$(OneDriveSiteUrl)" `
                  -FilePath  "$(ProdFilePath)"

          - task: PowerShell@2
            displayName: Refresh Dataset (PROD)
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Refresh-Dataset.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"
 