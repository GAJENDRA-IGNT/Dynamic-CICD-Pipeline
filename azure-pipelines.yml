# ============================================
# Power BI CI/CD Pipeline with Gateway Binding
# ============================================
# This pipeline:
#   1. Publishes PBIX to workspace
#   2. Takes dataset ownership
#   3. Binds dataset to gateway (CREDENTIALS PERSIST!)
#   4. Updates parameters for environment
#   5. Refreshes dataset
#
# IMPORTANT: Gateway binding solves the credential issue
#            for SharePoint/OneDrive data sources
# ============================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - Reports/*.pbix
      - Scripts/*.ps1
      - azure-pipelines.yml

pr: none

pool:
  vmImage: windows-latest

# ==========================================
# DEV STAGE
# ==========================================
stages:
- stage: DeployToDev
  displayName: 'üî∑ Deploy to DEV'
  variables:
    - group: PowerBI-Dev

  jobs:
  - job: DeployDEV
    displayName: 'Publish & Configure DEV'
    steps:

    - checkout: self

    # Step 1: Install Power BI Module
    - task: PowerShell@2
      displayName: 'üì¶ Install Power BI Module'
      inputs:
        targetType: inline
        script: |
          Write-Host "Installing MicrosoftPowerBIMgmt module..."
          Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber
          Write-Host "Module installed successfully"

    # Step 2: Publish PBIX
    - task: PowerShell@2
      displayName: 'üì§ Publish PBIX to DEV'
      inputs:
        targetType: inline
        script: |
          $pbixFiles = Get-ChildItem "$(Build.SourcesDirectory)/Reports" -Filter *.pbix
          
          if ($pbixFiles.Count -eq 0) {
            Write-Error "No .pbix files found in Reports folder!"
            exit 1
          }

          foreach ($pbix in $pbixFiles) {
            Write-Host "Publishing: $($pbix.Name)"
            
            & "$(Build.SourcesDirectory)/Scripts/Publish-PowerBIReport.ps1" `
              -ClientId "$(ServicePrincipalClientId)" `
              -ClientSecret "$(ServicePrincipalSecret)" `
              -TenantId "$(TenantId)" `
              -WorkspaceId "$(DevWorkspaceId)" `
              -ReportPath $pbix.FullName
          }

    # Step 3: Take Dataset Ownership
    - task: PowerShell@2
      displayName: 'üîë Take Dataset Ownership (DEV)'
      inputs:
        targetType: inline
        script: |
          if ([string]::IsNullOrEmpty("$(DatasetId)")) {
            Write-Error "DatasetId not found. Publish step may have failed."
            exit 1
          }

          & "$(Build.SourcesDirectory)/Scripts/Take-DatasetOwnership.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)"

    # Step 4: Bind to Gateway (THE KEY STEP!)
    - task: PowerShell@2
      displayName: 'üîó Bind Dataset to Gateway (DEV)'
      inputs:
        targetType: inline
        script: |
          Write-Host "Binding dataset to gateway for credential persistence..."
          
          & "$(Build.SourcesDirectory)/Scripts/Bind-DatasetToGateway.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -GatewayId "$(GatewayId)" `
            -DatasourceId "$(DatasourceId)"

    # Step 5: Update Parameters
    - task: PowerShell@2
      displayName: '‚öôÔ∏è Update SharePoint Parameters (DEV)'
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Update-OneDriveFilePath.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -SharePointSiteUrl "$(SharePointSiteUrl)" `
            -FilePath "$(DevFilePath)"

    # Step 6: Refresh Dataset
    - task: PowerShell@2
      displayName: 'üîÑ Refresh Dataset (DEV)'
      inputs:
        targetType: inline
        script: |
          & "$(Build.SourcesDirectory)/Scripts/Refresh-Dataset.ps1" `
            -ClientId "$(ServicePrincipalClientId)" `
            -ClientSecret "$(ServicePrincipalSecret)" `
            -TenantId "$(TenantId)" `
            -WorkspaceId "$(DevWorkspaceId)" `
            -DatasetId "$(DatasetId)" `
            -TimeoutMinutes 10

    # Step 7: Publish Artifacts for PROD
    - task: PublishPipelineArtifact@1
      displayName: 'üìÅ Publish Artifacts'
      inputs:
        targetPath: $(Build.SourcesDirectory)
        artifact: PowerBIReports


# ==========================================
# PROD STAGE
# ==========================================
- stage: DeployToProd
  displayName: 'üü¢ Deploy to PROD'
  dependsOn: DeployToDev
  variables:
    - group: PowerBI-Prod

  jobs:
  - deployment: DeployPROD
    displayName: 'Publish & Configure PROD'
    environment: PowerBI-Production
    strategy:
      runOnce:
        deploy:
          steps:

          # Download artifacts
          - task: DownloadPipelineArtifact@2
            displayName: 'üì• Download Artifacts'
            inputs:
              artifact: PowerBIReports
              path: $(Pipeline.Workspace)

          # Install Power BI Module
          - task: PowerShell@2
            displayName: 'üì¶ Install Power BI Module'
            inputs:
              targetType: inline
              script: |
                Install-Module MicrosoftPowerBIMgmt -Force -Scope CurrentUser -AllowClobber

          # Publish PBIX to PROD
          - task: PowerShell@2
            displayName: 'üì§ Publish PBIX to PROD'
            inputs:
              targetType: inline
              script: |
                $pbixFiles = Get-ChildItem "$(Pipeline.Workspace)/Reports" -Filter *.pbix

                foreach ($pbix in $pbixFiles) {
                  Write-Host "Publishing: $($pbix.Name)"
                  
                  & "$(Pipeline.Workspace)/Scripts/Publish-PowerBIReport.ps1" `
                    -ClientId "$(ServicePrincipalClientId)" `
                    -ClientSecret "$(ServicePrincipalSecret)" `
                    -TenantId "$(TenantId)" `
                    -WorkspaceId "$(ProdWorkspaceId)" `
                    -ReportPath $pbix.FullName
                }

          # Take Dataset Ownership
          - task: PowerShell@2
            displayName: 'üîë Take Dataset Ownership (PROD)'
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Take-DatasetOwnership.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)"

          # Bind to Gateway (THE KEY STEP!)
          - task: PowerShell@2
            displayName: 'üîó Bind Dataset to Gateway (PROD)'
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Bind-DatasetToGateway.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -GatewayId "$(GatewayId)" `
                  -DatasourceId "$(DatasourceId)"

          # Update Parameters
          - task: PowerShell@2
            displayName: '‚öôÔ∏è Update SharePoint Parameters (PROD)'
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Update-OneDriveFilePath.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -SharePointSiteUrl "$(SharePointSiteUrl)" `
                  -FilePath "$(ProdFilePath)"

          # Refresh Dataset
          - task: PowerShell@2
            displayName: 'üîÑ Refresh Dataset (PROD)'
            inputs:
              targetType: inline
              script: |
                & "$(Pipeline.Workspace)/Scripts/Refresh-Dataset.ps1" `
                  -ClientId "$(ServicePrincipalClientId)" `
                  -ClientSecret "$(ServicePrincipalSecret)" `
                  -TenantId "$(TenantId)" `
                  -WorkspaceId "$(ProdWorkspaceId)" `
                  -DatasetId "$(DatasetId)" `
                  -TimeoutMinutes 10